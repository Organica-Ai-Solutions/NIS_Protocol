<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIS Protocol - Enhanced Modern Chat</title>
    
    <!-- NIS State Management System -->
    <script src="/static/js/nis-state-client.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0A0A0B;
            color: white;
            overflow-x: hidden;
            height: 100vh;
        }

        .chat-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        /* Animated Background */
        .bg-gradient {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(128px);
            mix-blend-mode: normal;
            animation: pulse 4s ease-in-out infinite;
        }

        .bg-orb:nth-child(1) {
            top: 0;
            left: 25%;
            width: 384px;
            height: 384px;
            background: rgba(139, 92, 246, 0.1);
            animation-delay: 0s;
        }

        .bg-orb:nth-child(2) {
            bottom: 0;
            right: 25%;
            width: 384px;
            height: 384px;
            background: rgba(99, 102, 241, 0.1);
            animation-delay: 0.7s;
        }

        .bg-orb:nth-child(3) {
            top: 25%;
            right: 33%;
            width: 256px;
            height: 256px;
            background: rgba(217, 70, 239, 0.1);
            filter: blur(96px);
            animation-delay: 1s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .main-content {
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 48px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease-out forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            animation: fadeInUp 0.5s ease-out 0.2s both;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 500;
            letter-spacing: -0.025em;
            background: linear-gradient(to right, rgba(255,255,255,0.9), rgba(255,255,255,0.4));
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            margin-bottom: 8px;
        }

        .header-line {
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent);
            width: 0;
            margin: 0 auto 12px;
            animation: expandLine 0.8s ease-out 0.5s both;
        }

        @keyframes expandLine {
            to { width: 100%; }
        }

        .header p {
            font-size: 0.875rem;
            color: rgba(255,255,255,0.4);
            opacity: 0;
            animation: fadeIn 0.5s ease-out 0.3s both;
        }

        .chat-toggle-container {
            margin-top: 16px;
            opacity: 0;
            animation: fadeIn 0.5s ease-out 0.4s both;
        }

        .classic-chat-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .classic-chat-link:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.9);
            transform: translateY(-1px);
        }

        .classic-chat-link span {
            font-size: 0.9rem;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* Chat Box */
        .chat-box {
            backdrop-filter: blur(32px);
            background: rgba(255,255,255,0.02);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);
            position: relative;
            transform: scale(0.98);
            animation: scaleIn 0.5s ease-out 0.1s both;
        }

        @keyframes scaleIn {
            to { transform: scale(1); }
        }

        /* Command Palette */
        .command-palette {
            position: absolute;
            left: 16px;
            right: 16px;
            bottom: 100%;
            margin-bottom: 8px;
            backdrop-filter: blur(24px);
            background: rgba(0,0,0,0.9);
            border-radius: 8px;
            z-index: 50;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
            display: none;
            opacity: 0;
            transform: translateY(5px);
            transition: all 0.15s ease-out;
        }

        .command-palette.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .command-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            cursor: pointer;
            color: rgba(255,255,255,0.7);
        }

        .command-item:hover,
        .command-item.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .command-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.6);
        }

        .command-prefix {
            color: rgba(255,255,255,0.4);
            font-size: 0.75rem;
            margin-left: 4px;
        }

        /* Text Area */
        .input-container {
            padding: 16px;
        }

        .chat-textarea {
            width: 100%;
            min-height: 60px;
            max-height: 200px;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.9);
            font-size: 0.875rem;
            resize: none;
            outline: none;
            font-family: inherit;
            line-height: 1.5;
        }

        .chat-textarea::placeholder {
            color: rgba(255,255,255,0.2);
        }

        .textarea-ring {
            position: absolute;
            inset: 0;
            border-radius: 8px;
            pointer-events: none;
            border: 2px solid rgba(139, 92, 246, 0.3);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .chat-textarea:focus + .textarea-ring {
            opacity: 1;
        }

        /* Attachments */
        .attachments {
            padding: 0 16px 12px;
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .attachments.show {
            display: flex;
            opacity: 1;
            max-height: 200px;
        }

        .attachment {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            background: rgba(255,255,255,0.03);
            padding: 6px 12px;
            border-radius: 8px;
            color: rgba(255,255,255,0.7);
            animation: fadeInScale 0.3s ease;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .attachment-remove {
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .attachment-remove:hover {
            color: white;
        }

        /* Controls */
        .chat-controls {
            padding: 16px;
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-btn {
            padding: 8px;
            color: rgba(255,255,255,0.4);
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .control-btn:hover {
            color: rgba(255,255,255,0.9);
            background: rgba(255,255,255,0.05);
        }

        .control-btn.active {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.9);
        }

        .send-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .send-btn:disabled {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.4);
            cursor: not-allowed;
        }

        .send-btn:not(:disabled) {
            background: white;
            color: #0A0A0B;
            box-shadow: 0 4px 8px rgba(255,255,255,0.1);
        }

        .send-btn:not(:disabled):hover {
            transform: scale(1.01);
        }

        .send-btn:not(:disabled):active {
            transform: scale(0.98);
        }

        /* Command Suggestions */
        .command-suggestions {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 8px;
            animation: fadeInUp 0.5s ease-out;
        }

        .suggestion-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
            font-size: 0.875rem;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .suggestion-btn:nth-child(1) { animation-delay: 0s; }
        .suggestion-btn:nth-child(2) { animation-delay: 0.1s; }
        .suggestion-btn:nth-child(3) { animation-delay: 0.2s; }
        .suggestion-btn:nth-child(4) { animation-delay: 0.3s; }

        .suggestion-btn:hover {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.9);
            transform: translateY(-2px);
        }

        /* Typing Indicator */
        .typing-indicator {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            backdrop-filter: blur(32px);
            background: rgba(255,255,255,0.02);
            border-radius: 9999px;
            padding: 8px 16px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
            display: none;
            align-items: center;
            gap: 12px;
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
            transition: all 0.3s ease;
        }

        .typing-indicator.show {
            display: flex;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .typing-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 500;
            color: rgba(255,255,255,0.9);
        }

        .typing-text {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            color: rgba(255,255,255,0.7);
        }

        .typing-dots {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(255,255,255,0.3);
            animation: typingDot 1.2s ease-in-out infinite;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.15s; }
        .typing-dot:nth-child(3) { animation-delay: 0.3s; }

        @keyframes typingDot {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: scale(0.85);
            }
            30% {
                opacity: 0.9;
                transform: scale(1.1);
            }
        }

        /* Focus glow effect */
        .focus-glow {
            position: fixed;
            width: 800px;
            height: 800px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.02;
            background: linear-gradient(to right, rgb(139, 92, 246), rgb(217, 70, 239), rgb(99, 102, 241));
            filter: blur(96px);
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            display: none;
        }

        .focus-glow.active {
            display: block;
        }

        /* Chat Messages Area */
        .chat-messages {
            flex: 1;
            max-height: 400px;
            overflow-y: auto;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }

        .chat-messages.show {
            display: block;
        }

        /* Terminal Integration */
        .terminal-section {
            border-top: 1px solid rgba(255,255,255,0.05);
            background: rgba(0,0,0,0.3);
            border-radius: 0 0 16px 16px;
            display: none;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .terminal-section.show {
            display: block;
            opacity: 1;
            max-height: 300px;
        }

        .terminal-header {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0,0,0,0.2);
        }

        .terminal-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            color: rgba(255,255,255,0.7);
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        }

        .terminal-controls {
            display: flex;
            gap: 8px;
        }

        .terminal-btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .terminal-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .terminal-output {
            padding: 16px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.75rem;
            line-height: 1.4;
            color: rgba(255,255,255,0.8);
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0,0,0,0.4);
        }

        .terminal-input-container {
            padding: 12px 16px;
            background: rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal-prompt {
            color: rgba(99, 102, 241, 0.8);
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.75rem;
        }

        .terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.75rem;
            outline: none;
        }

        .terminal-input::placeholder {
            color: rgba(255,255,255,0.3);
        }

        /* Code Block Styling */
        .code-block {
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.75rem;
            line-height: 1.4;
            position: relative;
        }

        .code-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .code-language {
            color: rgba(99, 102, 241, 0.8);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .code-actions {
            display: flex;
            gap: 4px;
        }

        .code-action-btn {
            padding: 2px 6px;
            font-size: 0.6rem;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 3px;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .code-action-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .message {
            margin-bottom: 16px;
            animation: messageSlideIn 0.3s ease;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-user {
            text-align: right;
        }

        .message-bubble {
            display: inline-block;
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .message-user .message-bubble {
            background: rgba(139, 92, 246, 0.2);
            color: white;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .message-assistant {
            text-align: left;
        }

        .message-assistant .message-bubble {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.9);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .message-time {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.4);
            margin-top: 4px;
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }

        /* LangChain Agent UI Styles */
        .tool-call {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            margin: 8px 0;
            overflow: hidden;
        }

        .tool-header {
            padding: 12px 16px;
            background: rgba(59, 130, 246, 0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .tool-header:hover {
            background: rgba(59, 130, 246, 0.15);
        }

        .tool-icon {
            font-size: 16px;
        }

        .tool-name {
            font-weight: 600;
            font-size: 14px;
            flex: 1;
        }

        .tool-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .tool-status.running {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .tool-status.completed {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .tool-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .tool-content {
            padding: 16px;
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 13px;
            background: rgba(0,0,0,0.3);
            display: none;
        }

        .tool-content.expanded {
            display: block;
        }

        .tool-args, .tool-result {
            margin-bottom: 12px;
        }

        .tool-result {
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .reasoning-step {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            margin: 8px 0;
            padding: 16px;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(139, 92, 246, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .step-title {
            font-weight: 600;
            font-size: 14px;
            color: #a78bfa;
        }

        .step-content {
            font-size: 14px;
            line-height: 1.5;
            color: rgba(255,255,255,0.9);
        }

        .artifact-container {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            margin: 8px 0;
            overflow: hidden;
        }

        .artifact-header {
            padding: 12px 16px;
            background: rgba(16, 185, 129, 0.1);
            border-bottom: 1px solid rgba(16, 185, 129, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .artifact-icon {
            font-size: 16px;
        }

        .artifact-title {
            font-weight: 600;
            font-size: 14px;
            color: #10b981;
            flex: 1;
        }

        .artifact-action {
            padding: 4px 12px;
            background: rgba(16, 185, 129, 0.2);
            border: none;
            border-radius: 6px;
            color: #10b981;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .artifact-action:hover {
            background: rgba(16, 185, 129, 0.3);
        }

        .artifact-preview {
            padding: 16px;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Agent Workflow Visualization */
        .agent-workflow {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }

        .workflow-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
        }

        .workflow-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .workflow-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            font-size: 14px;
        }

        .workflow-step.active {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .workflow-step.completed {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .step-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .step-icon.active {
            background: rgba(59, 130, 246, 0.3);
            color: #3b82f6;
        }

        .step-icon.completed {
            background: rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .chat-container {
                padding: 16px;
            }
            
            .main-content {
                gap: 32px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .command-suggestions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Animated Background -->
        <div class="bg-gradient">
            <div class="bg-orb"></div>
            <div class="bg-orb"></div>
            <div class="bg-orb"></div>
        </div>

        <!-- Focus Glow Effect -->
        <div class="focus-glow" id="focusGlow"></div>

        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h1>ü§ñ NIS Protocol AI Assistant <span class="dev-badge" style="font-size: 14px; background-color: #2a2a2a; color: #3b82f6; padding: 4px 8px; border-radius: 4px; margin-left: 10px;">DEV MODE</span></h1>
                <div class="header-line"></div>
                <p>Intelligent system analysis and real-time insights</p>
                <div class="chat-toggle-container">
                    <a href="/console" class="classic-chat-link">
                        <span>üîÑ</span>
                        Switch to Classic Chat
                    </a>
                    <a href="/enhanced" class="classic-chat-link" style="margin-left: 12px;">
                        <span>üöÄ</span>
                        Enhanced Agent Chat
                    </a>
                    <button id="toggleDevTools" style="margin-left: 12px; background-color: #2a2a2a; color: #3b82f6; border: 1px solid #374151; border-radius: 4px; padding: 4px 8px; cursor: pointer;">
                        <span>üõ†Ô∏è</span>
                        Dev Tools
                    </button>
                </div>
            </div>
            
            <!-- Development Tools Panel -->
            <div id="devToolsPanel" style="display: none; position: absolute; top: 120px; right: 20px; width: 400px; background-color: #1a1a1a; border: 1px solid #374151; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; padding: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-bottom: 1px solid #374151; padding-bottom: 8px;">
                    <h3 style="margin: 0; color: #3b82f6;">üõ†Ô∏è Development Tools</h3>
                    <button id="closeDevTools" style="background: none; border: none; color: #a0a0a0; font-size: 20px; cursor: pointer;">√ó</button>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; color: #a0a0a0;">Endpoint Testing</h4>
                    <div style="display: flex; gap: 8px;">
                        <select id="endpointSelect" style="flex: 1; background-color: #2a2a2a; color: white; border: 1px solid #374151; border-radius: 4px; padding: 6px;">
                            <option value="/chat">Standard Chat</option>
                            <option value="/chat/stream" selected>Streaming Chat</option>
                            <option value="/chat/formatted">Formatted Chat</option>
                        </select>
                        <button id="testEndpoint" style="background-color: #3b82f6; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer;">Test</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; color: #a0a0a0;">Response Debug</h4>
                    <div style="display: flex; gap: 16px;">
                        <label style="display: flex; align-items: center; gap: 4px; color: white;">
                            <input type="checkbox" id="showRawResponse"> Show Raw JSON
                        </label>
                        <label style="display: flex; align-items: center; gap: 4px; color: white;">
                            <input type="checkbox" id="showTimings"> Show Timings
                        </label>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <h4 style="margin: 0 0 8px 0; color: #a0a0a0;">WebSocket Testing</h4>
                    <div style="display: flex; gap: 8px;">
                        <button id="testWebSocket" style="background-color: #3b82f6; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer;">Test Connection</button>
                        <button id="sendTestEvent" style="background-color: #3b82f6; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer;">Send Test Event</button>
                    </div>
                    <div id="wsStatus" style="margin-top: 8px; color: #a0a0a0;">WebSocket: Unknown</div>
                </div>
                
                <div>
                    <h4 style="margin: 0 0 8px 0; color: #a0a0a0;">Network Monitor</h4>
                    <div id="networkLog" style="max-height: 150px; overflow-y: auto; background-color: #2a2a2a; border-radius: 4px; padding: 8px; font-family: monospace; font-size: 12px; color: #a0a0a0;">
                        <div>No requests logged yet</div>
                    </div>
                    <button id="clearNetworkLog" style="margin-top: 8px; background-color: #2a2a2a; color: white; border: 1px solid #374151; border-radius: 4px; padding: 4px 8px; cursor: pointer; width: 100%;">Clear Log</button>
                </div>
            </div>

            <!-- Chat Box -->
            <div class="chat-box">
                <!-- Command Palette -->
                <div class="command-palette" id="commandPalette">
                    <div class="command-item" data-prefix="/clone" data-label="Clone UI">
                        <div class="command-icon">üñºÔ∏è</div>
                        <div>Clone UI</div>
                        <div class="command-prefix">/clone</div>
                    </div>
                    <div class="command-item" data-prefix="/figma" data-label="Import Figma">
                        <div class="command-icon">üé®</div>
                        <div>Import Figma</div>
                        <div class="command-prefix">/figma</div>
                    </div>
                    <div class="command-item" data-prefix="/page" data-label="Create Page">
                        <div class="command-icon">üìÑ</div>
                        <div>Create Page</div>
                        <div class="command-prefix">/page</div>
                    </div>
                    <div class="command-item" data-prefix="/improve" data-label="Improve">
                        <div class="command-icon">‚ú®</div>
                        <div>Improve</div>
                        <div class="command-prefix">/improve</div>
                    </div>
                    <div class="command-item" data-prefix="/run" data-label="Run Code">
                        <div class="command-icon">üîß</div>
                        <div>Run Code</div>
                        <div class="command-prefix">/run</div>
                    </div>
                    <div class="command-item" data-prefix="/python" data-label="Python Script">
                        <div class="command-icon">üêç</div>
                        <div>Python Script</div>
                        <div class="command-prefix">/python</div>
                    </div>
                    <div class="command-item" data-prefix="/terminal" data-label="Terminal">
                        <div class="command-icon">üíª</div>
                        <div>Terminal</div>
                        <div class="command-prefix">/terminal</div>
                    </div>
                    <div class="command-item" data-prefix="/file" data-label="File Operations">
                        <div class="command-icon">üìÅ</div>
                        <div>File Operations</div>
                        <div class="command-prefix">/file</div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages" id="chatMessages"></div>

                <!-- Input Container -->
                <div class="input-container">
                    <div style="position: relative;">
                        <textarea 
                            id="chatInput" 
                            class="chat-textarea" 
                            placeholder="Ask the NIS Protocol AI Assistant..."
                            rows="1"
                        ></textarea>
                        <div class="textarea-ring"></div>
                    </div>
                </div>

                <!-- Attachments -->
                <div class="attachments" id="attachments"></div>

                <!-- Controls -->
                <div class="chat-controls">
                    <div class="control-buttons">
                        <button class="control-btn" id="attachBtn" title="Attach file">
                            üìé
                        </button>
                        <button class="control-btn" id="commandBtn" title="Commands">
                            ‚åò
                        </button>
                        <button class="control-btn" id="runnerBtn" title="Runner Terminal">
                            üîß
                        </button>
                    </div>
                    <button class="send-btn" id="sendBtn" disabled>
                        <span id="sendIcon">üì§</span>
                        <span>Send</span>
                    </button>
                    <button class="control-btn" id="terminalBtn" title="Terminal">
                        üíª
                    </button>
                </div>
            </div>

            <!-- Terminal Section -->
            <div class="terminal-section" id="terminalSection">
                <div class="terminal-header">
                    <div class="terminal-title">
                        <span>üîß</span>
                        <span>NIS Runner Terminal</span>
                    </div>
                    <div class="terminal-controls">
                        <button class="terminal-btn" id="clearTerminal">Clear</button>
                        <button class="terminal-btn" id="closeTerminal">Close</button>
                    </div>
                </div>
                <div class="terminal-output" id="terminalOutput">
                    <div style="color: rgba(99, 102, 241, 0.8);">NIS Protocol Runner v1.0.0</div>
                    <div style="color: rgba(255,255,255,0.6);">Secure execution environment ready.</div>
                    <div style="color: rgba(255,255,255,0.4);">Type 'help' for available commands.</div>
                </div>
                <div class="terminal-input-container">
                    <span class="terminal-prompt">runner $</span>
                    <input type="text" class="terminal-input" id="terminalInput" placeholder="Enter command...">
                </div>
            </div>
        </div>

            <!-- Command Suggestions -->
            <div class="command-suggestions">
                <button class="suggestion-btn" data-command="/run">
                    <span>üîß</span>
                    <span>Run Code</span>
                </button>
                <button class="suggestion-btn" data-command="/python">
                    <span>üêç</span>
                    <span>Python Script</span>
                </button>
                <button class="suggestion-btn" data-command="/terminal">
                    <span>üíª</span>
                    <span>Terminal</span>
                </button>
                <button class="suggestion-btn" data-command="/file">
                    <span>üìÅ</span>
                    <span>File Ops</span>
                </button>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-avatar">AI</div>
            <div class="typing-text">
                <span>Thinking</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let attachments = [];
        let activeSuggestion = -1;
        let isTyping = false;
        let currentController = null;

        // DOM elements
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const attachBtn = document.getElementById('attachBtn');
        const commandBtn = document.getElementById('commandBtn');
        const commandPalette = document.getElementById('commandPalette');
        const attachmentsContainer = document.getElementById('attachments');
        const typingIndicator = document.getElementById('typingIndicator');
        const focusGlow = document.getElementById('focusGlow');
        const chatMessages = document.getElementById('chatMessages');
        const sendIcon = document.getElementById('sendIcon');

        // Auto-resize textarea
        function adjustTextareaHeight() {
            chatInput.style.height = '60px';
            const newHeight = Math.max(60, Math.min(chatInput.scrollHeight, 200));
            chatInput.style.height = newHeight + 'px';
        }

        // Show/hide command palette
        function showCommandPalette() {
            commandPalette.classList.add('show');
            updateActiveSuggestion();
        }

        function hideCommandPalette() {
            commandPalette.classList.remove('show');
            activeSuggestion = -1;
        }

        // Update active command suggestion
        function updateActiveSuggestion() {
            const items = commandPalette.querySelectorAll('.command-item');
            items.forEach((item, index) => {
                item.classList.toggle('active', index === activeSuggestion);
            });
        }

        // Apply command from palette
        function applyCommand(prefix) {
            chatInput.value = prefix + ' ';
            hideCommandPalette();
            chatInput.focus();
            adjustTextareaHeight();
            updateSendButton();
        }

        // Update send button state
        function updateSendButton() {
            const hasText = chatInput.value.trim().length > 0;
            sendBtn.disabled = !hasText || isTyping;
        }

        // Add attachment
        function addAttachment() {
            const fileName = `file-${Math.floor(Math.random() * 1000)}.pdf`;
            attachments.push(fileName);
            renderAttachments();
        }

        // Remove attachment
        function removeAttachment(index) {
            attachments.splice(index, 1);
            renderAttachments();
        }

        // Render attachments
        function renderAttachments() {
            attachmentsContainer.innerHTML = '';
            if (attachments.length > 0) {
                attachmentsContainer.classList.add('show');
                attachments.forEach((file, index) => {
                    const attachment = document.createElement('div');
                    attachment.className = 'attachment';
                    attachment.innerHTML = `
                        <span>${file}</span>
                        <span class="attachment-remove" onclick="removeAttachment(${index})">‚úï</span>
                    `;
                    attachmentsContainer.appendChild(attachment);
                });
            } else {
                attachmentsContainer.classList.remove('show');
            }
        }

        // Add message to chat
        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.classList.add('show');
            
            const message = document.createElement('div');
            message.className = `message ${isUser ? 'message-user' : 'message-assistant'}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = content;
            
            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = new Date().toLocaleTimeString();
            
            message.appendChild(bubble);
            message.appendChild(time);
            messagesContainer.appendChild(message);
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Show typing indicator
        function showTyping() {
            isTyping = true;
            typingIndicator.classList.add('show');
            updateSendButton();
        }

        // Hide typing indicator
        function hideTyping() {
            isTyping = false;
            typingIndicator.classList.remove('show');
            updateSendButton();
        }

        // Execute runner command
        async function executeRunnerCommand(command) {
            try {
                const response = await fetch('/api/langgraph/invoke', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tool: "run_shell",
                        args: { cmd: command, timeout: 30 }
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    const output = result.stdout || 'Command executed successfully';
                    addMessage(`üîß Runner: ${command}\n\`\`\`\n${output}\n\`\`\``, false);
                } else {
                    const error = result.error || result.stderr || 'Command failed';
                    addMessage(`‚ùå Runner Error: ${command}\n\`\`\`\n${error}\n\`\`\``, false);
                }
            } catch (error) {
                addMessage(`üö® Runner Connection Error: ${error.message}`, false);
            }
        }

        // Execute Python script
        async function executePythonScript(filename, content) {
            try {
                // First, write the script
                await fetch('/tools/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tool: "write_script",
                        args: { filename: filename, content: content }
                    })
                });

                // Then execute it
                const response = await fetch('/api/langgraph/invoke', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tool: "run_python",
                        args: { filepath: filename, timeout: 60 }
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    const output = result.stdout || 'Script executed successfully';
                    addMessage(`üêç Python: ${filename}\n\`\`\`\n${output}\n\`\`\``, false);
                } else {
                    const error = result.error || result.stderr || 'Script failed';
                    addMessage(`‚ùå Python Error: ${filename}\n\`\`\`\n${error}\n\`\`\``, false);
                }
            } catch (error) {
                addMessage(`üö® Python Execution Error: ${error.message}`, false);
            }
        }

        // LangChain Agent UI - Tool Call Visualization
        function createToolCallElement(toolCall) {
            const toolElement = document.createElement('div');
            toolElement.className = 'tool-call';
            toolElement.innerHTML = `
                <div class="tool-header">
                    <span class="tool-icon">üîß</span>
                    <span class="tool-name">${toolCall.name}</span>
                    <span class="tool-status ${toolCall.status || 'running'}">${toolCall.status || 'Running'}</span>
                </div>
                <div class="tool-content">
                    <div class="tool-args">
                        <strong>Arguments:</strong>
                        <pre>${JSON.stringify(toolCall.args || {}, null, 2)}</pre>
                    </div>
                    ${toolCall.result ? `
                        <div class="tool-result">
                            <strong>Result:</strong>
                            <pre>${JSON.stringify(toolCall.result, null, 2)}</pre>
                        </div>
                    ` : ''}
                </div>
            `;
            return toolElement;
        }

        // LangChain Agent UI - Reasoning Steps
        function createReasoningElement(step, index) {
            const stepElement = document.createElement('div');
            stepElement.className = 'reasoning-step';
            stepElement.innerHTML = `
                <div class="step-header">
                    <span class="step-number">${index + 1}</span>
                    <span class="step-title">${step.title || 'Reasoning Step'}</span>
                </div>
                <div class="step-content">${step.content || step}</div>
            `;
            return stepElement;
        }

        // LangChain Agent UI - Artifact Rendering
        function createArtifactElement(artifact) {
            const artifactElement = document.createElement('div');
            artifactElement.className = 'artifact-container';
            artifactElement.innerHTML = `
                <div class="artifact-header">
                    <span class="artifact-icon">üìÑ</span>
                    <span class="artifact-title">${artifact.title || 'Artifact'}</span>
                    <button class="artifact-action" onclick="openArtifact('${artifact.id}')">View</button>
                </div>
                <div class="artifact-preview">
                    ${artifact.preview || artifact.content || 'No preview available'}
                </div>
            `;
            return artifactElement;
        }

        // Send message with streaming
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || isTyping) return;

            // Check for runner commands
            if (message.startsWith('/run ')) {
                const command = message.substring(5);
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                await executeRunnerCommand(command);
                return;
            }

            if (message.startsWith('/python ')) {
                const code = message.substring(8);
                const filename = `script_${Date.now()}.py`;
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                await executePythonScript(filename, code);
                return;
            }

            // File operations
            if (message === '/files') {
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('list_files', {});
                    const files = result.files || [];
                    const fileList = files.map(f => `${f.type === 'directory' ? 'üìÅ' : 'üìÑ'} ${f.name} (${f.size} bytes)`).join('\n');
                    addMessage(`üìÅ Workspace Files:\n\`\`\`\n${fileList || 'No files found'}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`‚ùå Error: ${error.message}`, false);
                }
                return;
            }

            if (message.startsWith('/read ')) {
                const filename = message.substring(6);
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('read_file', { filepath: filename });
                    addMessage(`üìÑ File: ${filename}\n\`\`\`\n${result.content}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`‚ùå Error reading file: ${error.message}`, false);
                }
                return;
            }

            if (message.startsWith('/mkdir ')) {
                const dirname = message.substring(7);
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('create_directory', { path: dirname });
                    addMessage(`‚úÖ Directory created: ${result.path}`, false);
                } catch (error) {
                    addMessage(`‚ùå Error creating directory: ${error.message}`, false);
                }
                return;
            }

            if (message.startsWith('/delete ')) {
                const filename = message.substring(8);
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('delete_file', { filepath: filename });
                    addMessage(`üóëÔ∏è File deleted: ${result.deleted}`, false);
                } catch (error) {
                    addMessage(`‚ùå Error deleting file: ${error.message}`, false);
                }
                return;
            }

            // System info commands
            if (message === '/sysinfo') {
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('system_info', {});
                    const info = result.system_info;
                    addMessage(`üíª System Information:\n\`\`\`\nPlatform: ${info.platform}\nPython: ${info.python_version}\nCPU Cores: ${info.cpu_count}\nMemory: ${(info.memory_available / 1024 / 1024 / 1024).toFixed(2)} GB available\nDisk Usage: ${info.disk_usage}%\nWorkspace: ${info.workspace}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`‚ùå Error getting system info: ${error.message}`, false);
                }
                return;
            }

            if (message === '/disk') {
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('disk_usage', {});
                    const disk = result.disk_usage;
                    addMessage(`üíΩ Disk Usage:\n\`\`\`\nTotal: ${(disk.total / 1024 / 1024 / 1024).toFixed(2)} GB\nUsed: ${(disk.used / 1024 / 1024 / 1024).toFixed(2)} GB\nFree: ${(disk.free / 1024 / 1024 / 1024).toFixed(2)} GB\nUsage: ${disk.percent_used.toFixed(1)}%\n\`\`\``, false);
                } catch (error) {
                    addMessage(`‚ùå Error getting disk usage: ${error.message}`, false);
                }
                return;
            }

            if (message === '/processes') {
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('process_list', {});
                    const processes = result.processes.slice(0, 10);
                    const processList = processes.map(p => `${p.pid}: ${p.name} (${p.cpu_percent}% CPU)`).join('\n');
                    addMessage(`‚öôÔ∏è Running Processes (Top 10):\n\`\`\`\n${processList}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`‚ùå Error getting processes: ${error.message}`, false);
                }
                return;
            }

            // Advanced tools
            if (message === '/report') {
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('generate_report', {});
                    addMessage(`üìä System Report Generated:\n\`\`\`\nSaved to: ${result.saved_to}\nGenerated: ${result.report.generated_at}\nFiles in workspace: ${result.report.workspace_files.length}\nRecent executions: ${result.report.execution_log.length}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`‚ùå Error generating report: ${error.message}`, false);
                }
                return;
            }

            if (message === '/backup') {
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('backup_workspace', {});
                    addMessage(`üíæ Workspace Backup Created:\n\`\`\`\nFile: ${result.backup_file}\nSize: ${(result.size / 1024).toFixed(2)} KB\nCreated: ${result.created_at}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`‚ùå Error creating backup: ${error.message}`, false);
                }
                return;
            }

            if (message.startsWith('/network') || message === '/network') {
                const host = message.includes(' ') ? message.split(' ')[1] : 'google.com';
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('network_test', { host: host });
                    addMessage(`üåê Network Test (${result.host}):\n\`\`\`\nStatus: ${result.response_time}\nConnectivity: ${result.success ? '‚úÖ Online' : '‚ùå Offline'}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`‚ùå Network test error: ${error.message}`, false);
                }
                return;
            }

            if (message === '/git') {
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('git_status', {});
                    if (result.is_git_repo) {
                        addMessage(`üîÑ Git Status:\n\`\`\`\n${result.clean ? 'Working directory clean' : result.status}\n\`\`\``, false);
                    } else {
                        addMessage(`üìÅ Not a git repository`, false);
                    }
                } catch (error) {
                    addMessage(`‚ùå Git error: ${error.message}`, false);
                }
                return;
            }

            if (message.startsWith('/install ')) {
                const package = message.substring(9);
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('install_package', { package: package });
                    addMessage(`üì¶ Package Installation:\n\`\`\`\nPackage: ${result.package}\nStatus: ${result.success ? '‚úÖ Installed' : '‚ùå Failed'}\n${result.output || result.error}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`‚ùå Installation error: ${error.message}`, false);
                }
                return;
            }

            // Add user message
            addMessage(message, true);
            
            // Clear input
            chatInput.value = '';
            attachments = [];
            renderAttachments();
            adjustTextareaHeight();
            updateSendButton();

            // Show typing indicator
            showTyping();
            sendIcon.textContent = '‚è≥';

            // Cancel any existing stream
            if (currentController) {
                currentController.abort();
            }

            currentController = new AbortController();

            try {
                // Use streaming endpoint for real-time responses
                const response = await fetch('/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        user_id: 'user_' + Date.now(),
                        agent_type: 'reasoning',
                        provider: 'anthropic',
                        stream: true,
                        include_reasoning: true,
                        include_tools: true
                    }),
                    signal: currentController.signal
                });

                if (!response.ok) {
                    // Fallback to regular streaming
                    const fallbackResponse = await fetch('/chat/stream', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            user_id: 'user_' + Date.now(),
                            agent_type: 'reasoning',
                            provider: 'anthropic'
                        }),
                        signal: currentController.signal
                    });
                    
                    if (!fallbackResponse.ok) {
                        throw new Error(`HTTP error! status: ${fallbackResponse.status}`);
                    }
                    
                    return handleBasicStream(fallbackResponse);
                }

                // Handle enhanced agent response with LangChain features
                const reader = response.body.getReader();
                let assistantMessage = '';
                let currentToolCalls = [];
                let currentReasoningSteps = [];
                let currentArtifacts = [];
                let messageElement = null;
                
                // Hide typing indicator and create initial message
                hideTyping();
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message message-assistant';
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.innerHTML = '';
                
                const time = document.createElement('div');
                time.className = 'message-time';
                time.textContent = new Date().toLocaleTimeString();
                
                messageDiv.appendChild(bubble);
                messageDiv.appendChild(time);
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = new TextDecoder().decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                switch (data.type) {
                                    case 'content':
                                        assistantMessage += data.data;
                                        bubble.innerHTML = formatMessage(assistantMessage);
                                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                        break;
                                        
                                    case 'tool_call':
                                        currentToolCalls.push(data.data);
                                        const toolElement = createToolCallElement(data.data);
                                        messageDiv.appendChild(toolElement);
                                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                        break;
                                        
                                    case 'reasoning_step':
                                        currentReasoningSteps.push(data.data);
                                        const reasoningElement = createReasoningElement(data.data, currentReasoningSteps.length - 1);
                                        messageDiv.appendChild(reasoningElement);
                                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                        break;
                                        
                                    case 'artifact':
                                        currentArtifacts.push(data.data);
                                        const artifactElement = createArtifactElement(data.data);
                                        messageDiv.appendChild(artifactElement);
                                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                        break;
                                        
                                    case 'workflow_update':
                                        updateWorkflowVisualization(data.data);
                                        break;
                                        
                                    case 'status':
                                        updateAgentStatus(data.data);
                                        break;
                                }
                            } catch (e) {
                                // Ignore JSON parse errors
                            }
                        }
                    }
                }

            } catch (error) {
                hideTyping();
                if (error.name !== 'AbortError') {
                    addMessage('Sorry, I encountered an error. Please try again.', false);
                    console.error('Chat error:', error);
                }
            } finally {
                sendIcon.textContent = 'üì§';
                currentController = null;
            }
        }

        // Mouse tracking for focus glow
        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            if (document.activeElement === chatInput) {
                focusGlow.style.transform = `translate(${mouseX - 400}px, ${mouseY - 400}px)`;
            }
        });

        // Event listeners
        chatInput.addEventListener('input', (e) => {
            adjustTextareaHeight();
            updateSendButton();
            
            const value = e.target.value;
            if (value.startsWith('/') && !value.includes(' ')) {
                showCommandPalette();
                
                const items = commandPalette.querySelectorAll('.command-item');
                let foundIndex = -1;
                items.forEach((item, index) => {
                    const prefix = item.getAttribute('data-prefix');
                    if (prefix.startsWith(value)) {
                        foundIndex = index;
                    }
                });
                activeSuggestion = foundIndex;
                updateActiveSuggestion();
            } else {
                hideCommandPalette();
            }
        });

        chatInput.addEventListener('focus', () => {
            focusGlow.classList.add('active');
        });

        chatInput.addEventListener('blur', () => {
            focusGlow.classList.remove('active');
        });

        chatInput.addEventListener('keydown', (e) => {
            if (commandPalette.classList.contains('show')) {
                const items = commandPalette.querySelectorAll('.command-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    activeSuggestion = activeSuggestion < items.length - 1 ? activeSuggestion + 1 : 0;
                    updateActiveSuggestion();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    activeSuggestion = activeSuggestion > 0 ? activeSuggestion - 1 : items.length - 1;
                    updateActiveSuggestion();
                } else if (e.key === 'Tab' || e.key === 'Enter') {
                    e.preventDefault();
                    if (activeSuggestion >= 0) {
                        const selectedItem = items[activeSuggestion];
                        applyCommand(selectedItem.getAttribute('data-prefix'));
                    }
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    hideCommandPalette();
                }
            } else if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);
        attachBtn.addEventListener('click', addAttachment);
        
        commandBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (commandPalette.classList.contains('show')) {
                hideCommandPalette();
            } else {
                chatInput.value = '/';
                chatInput.focus();
                showCommandPalette();
            }
        });

        // Enhanced runner commands
        async function executeRunnerTool(tool, args) {
            try {
                const response = await fetch('/api/langgraph/invoke', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ tool: tool, args: args })
                });

                const result = await response.json();
                
                if (result.success) {
                    return result;
                } else {
                    throw new Error(result.error || 'Tool execution failed');
                }
            } catch (error) {
                throw error;
            }
        }

        // Runner button functionality
        const runnerBtn = document.getElementById('runnerBtn');
        runnerBtn.addEventListener('click', () => {
            addMessage(`üîß **NIS Runner Terminal Ready!**

**üìÅ File Operations:**
‚Ä¢ \`/files\` - List all files
‚Ä¢ \`/read filename.txt\` - Read file content
‚Ä¢ \`/mkdir dirname\` - Create directory
‚Ä¢ \`/delete filename.txt\` - Delete file

**üêç Python & Scripts:**
‚Ä¢ \`/python print("hello")\` - Run Python code
‚Ä¢ \`/install numpy\` - Install Python packages

**üíª System Commands:**
‚Ä¢ \`/run ls -la\` - Shell commands
‚Ä¢ \`/sysinfo\` - System information
‚Ä¢ \`/processes\` - Running processes
‚Ä¢ \`/disk\` - Disk usage

**üîß Advanced Tools:**
‚Ä¢ \`/report\` - Generate system report
‚Ä¢ \`/backup\` - Backup workspace
‚Ä¢ \`/network\` - Test connectivity
‚Ä¢ \`/git\` - Git status

**Type any command to get started!** üöÄ`, false);
        });

        // Command palette click handlers
        commandPalette.addEventListener('click', (e) => {
            const item = e.target.closest('.command-item');
            if (item) {
                applyCommand(item.getAttribute('data-prefix'));
            }
        });

        // Suggestion button handlers
        document.querySelectorAll('.suggestion-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const command = btn.getAttribute('data-command');
                applyCommand(command);
            });
        });

        // Click outside to hide command palette
        document.addEventListener('click', (e) => {
            if (!commandPalette.contains(e.target) && !commandBtn.contains(e.target)) {
                hideCommandPalette();
            }
        });

        // LangChain Agent UI Helper Functions
        function handleBasicStream(response) {
            // Fallback for basic streaming without LangChain features
            const reader = response.body.getReader();
            let assistantMessage = '';
            
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-assistant';
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = '';
            
            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = new Date().toLocaleTimeString();
            
            messageDiv.appendChild(bubble);
            messageDiv.appendChild(time);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return reader.read().then(function processText({ done, value }) {
                if (done) return;
                
                const chunk = new TextDecoder().decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            if (data.type === 'content') {
                                assistantMessage += data.data;
                                bubble.textContent = assistantMessage;
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            }
                        } catch (e) {
                            // Ignore JSON parse errors
                        }
                    }
                }
                
                return reader.read().then(processText);
            });
        }

        function updateWorkflowVisualization(workflowData) {
            // Create or update workflow visualization
            let workflowElement = document.querySelector('.agent-workflow');
            if (!workflowElement) {
                workflowElement = document.createElement('div');
                workflowElement.className = 'agent-workflow';
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.appendChild(workflowElement);
            }
            
            workflowElement.innerHTML = `
                <div class="workflow-header">
                    <span>üîÑ</span>
                    <span>Agent Workflow</span>
                </div>
                <div class="workflow-steps">
                    ${workflowData.steps.map((step, index) => `
                        <div class="workflow-step ${step.status}">
                            <div class="step-icon ${step.status}">
                                ${step.status === 'completed' ? '‚úì' : step.status === 'active' ? '‚ü≥' : index + 1}
                            </div>
                            <span>${step.name}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateAgentStatus(statusData) {
            // Update agent status in the UI
            const statusElement = document.querySelector('.agent-status');
            if (statusElement) {
                statusElement.textContent = statusData.message;
                statusElement.className = `agent-status ${statusData.type}`;
            }
        }

        function openArtifact(artifactId) {
            // Open artifact in a modal or side panel
            console.log('Opening artifact:', artifactId);
            // Implementation for artifact viewing
        }

        function formatMessage(content) {
            if (typeof content !== 'string') {
                content = JSON.stringify(content, null, 2);
            }
            
            // Enhanced markdown-like formatting for LangChain
            content = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px;">$1</code>')
                .replace(/```(\w+)?\n([\s\S]*?)```/g, '<div class="code-block"><div class="code-header"><span class="code-language">$1</span></div><pre>$2</pre></div>')
                .replace(/\n/g, '<br>');

            return content;
        }

        // Enhanced Terminal Integration
        const terminalBtn = document.getElementById('terminalBtn');
        const terminalSection = document.getElementById('terminalSection');
        const terminalInput = document.getElementById('terminalInput');
        const terminalOutput = document.getElementById('terminalOutput');
        const clearTerminal = document.getElementById('clearTerminal');
        const closeTerminal = document.getElementById('closeTerminal');

        terminalBtn.addEventListener('click', () => {
            terminalSection.classList.toggle('show');
            if (terminalSection.classList.contains('show')) {
                terminalInput.focus();
            }
        });

        clearTerminal.addEventListener('click', () => {
            terminalOutput.innerHTML = `
                <div style="color: rgba(99, 102, 241, 0.8);">NIS Protocol Runner v1.0.0</div>
                <div style="color: rgba(255,255,255,0.6);">Secure execution environment ready.</div>
                <div style="color: rgba(255,255,255,0.4);">Type 'help' for available commands.</div>
            `;
        });

        closeTerminal.addEventListener('click', () => {
            terminalSection.classList.remove('show');
        });

        terminalInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const command = terminalInput.value.trim();
                if (!command) return;

                // Add command to terminal output
                const commandLine = document.createElement('div');
                commandLine.innerHTML = `<span style="color: rgba(99, 102, 241, 0.8);">runner $</span> ${command}`;
                terminalOutput.appendChild(commandLine);

                terminalInput.value = '';

                try {
                    const result = await executeRunnerTool('run_shell', { cmd: command });
                    const outputLine = document.createElement('div');
                    outputLine.style.color = 'rgba(255,255,255,0.8)';
                    outputLine.textContent = result.stdout || 'Command executed successfully';
                    terminalOutput.appendChild(outputLine);
                } catch (error) {
                    const errorLine = document.createElement('div');
                    errorLine.style.color = '#ef4444';
                    errorLine.textContent = `Error: ${error.message}`;
                    terminalOutput.appendChild(errorLine);
                }

                terminalOutput.scrollTop = terminalOutput.scrollHeight;
            }
        });

        // Tool call interaction handlers
        document.addEventListener('click', (e) => {
            if (e.target.closest('.tool-header')) {
                const toolCall = e.target.closest('.tool-call');
                const content = toolCall.querySelector('.tool-content');
                content.classList.toggle('expanded');
            }
        });

        // Initial setup
        adjustTextareaHeight();
        updateSendButton();
        
        // Welcome message with LangChain features
        setTimeout(() => {
            addMessage('üöÄ **NIS Protocol Modern Chat** - Enhanced with LangChain Agent UI\n\n**Features:**\n‚Ä¢ Real-time tool call visualization\n‚Ä¢ Agent reasoning steps\n‚Ä¢ Artifact rendering\n‚Ä¢ Workflow tracking\n‚Ä¢ Terminal integration\n\nType a command starting with "/" or ask me anything!', false);
        }, 1000);

        // ====== NIS STATE MANAGEMENT INTEGRATION ======
        
        class ModernChatComponent {
            constructor() {
                this.setupStateManagement();
                this.setupRealTimeUpdates();
                this.setupToolCallVisualization();
            }
            
            setupStateManagement() {
                // Register with NIS State Manager
                if (window.nisStateManager) {
                    window.nisStateManager.registerComponent('modern_chat', this);
                    console.log('üß† Modern Chat registered with NIS State Manager');
                } else {
                    console.warn('‚ö†Ô∏è NIS State Manager not available');
                }
            }
            
            setupRealTimeUpdates() {
                // Listen for real-time events
                if (window.nisStateManager) {
                    window.nisStateManager.client.on('chat_message', ({ data }) => {
                        this.handleRealTimeMessage(data);
                    });
                    
                    window.nisStateManager.client.on('agent_status_change', ({ data }) => {
                        this.updateAgentStatus(data);
                    });
                    
                    window.nisStateManager.client.on('backend_instruction', ({ data }) => {
                        this.handleBackendInstruction(data);
                    });
                    
                    window.nisStateManager.client.on('recommendation_generated', ({ data }) => {
                        this.showRecommendation(data);
                    });
                }
            }
            
            setupToolCallVisualization() {
                // Enhanced tool call visualization with real-time updates
                this.activeToolCalls = new Map();
                this.workflowSteps = [];
            }
            
            onStateUpdate(state) {
                console.log('üìä Modern Chat received state update:', Object.keys(state));
                
                // Update system status in header
                if (state.system_health) {
                    this.updateSystemStatus(state.system_health);
                }
                
                // Update active agents display
                if (state.active_agents) {
                    this.updateActiveAgentsDisplay(state.active_agents);
                }
                
                // Update performance metrics
                if (state.average_response_time) {
                    this.updatePerformanceDisplay(state.average_response_time);
                }
            }
            
            onEvent(eventType, data) {
                console.log('üéØ Modern Chat received event:', eventType, data);
                
                switch (eventType) {
                    case 'tool_call_started':
                        this.visualizeToolCallStart(data);
                        break;
                    case 'tool_call_completed':
                        this.visualizeToolCallComplete(data);
                        break;
                    case 'reasoning_step':
                        this.addReasoningStep(data);
                        break;
                    case 'workflow_update':
                        this.updateWorkflow(data);
                        break;
                }
            }
            
            updateSystemStatus(health) {
                // Update system status indicator
                const statusIndicator = document.querySelector('.system-status') || this.createStatusIndicator();
                statusIndicator.className = `system-status ${health}`;
                statusIndicator.textContent = `System: ${health}`;
            }
            
            createStatusIndicator() {
                const indicator = document.createElement('div');
                indicator.className = 'system-status';
                indicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 8px 16px;
                    border-radius: 20px;
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    font-size: 12px;
                    z-index: 1000;
                `;
                document.body.appendChild(indicator);
                return indicator;
            }
            
            updateActiveAgentsDisplay(agents) {
                // Show active agents in chat
                const agentCount = Object.keys(agents).length;
                const agentNames = Object.keys(agents).join(', ');
                
                this.addSystemMessage(`ü§ñ ${agentCount} agents active: ${agentNames}`);
            }
            
            updatePerformanceDisplay(responseTime) {
                // Update performance indicator
                const perfIndicator = document.querySelector('.performance-indicator') || this.createPerformanceIndicator();
                perfIndicator.textContent = `‚ö° ${Math.round(responseTime)}ms`;
            }
            
            createPerformanceIndicator() {
                const indicator = document.createElement('div');
                indicator.className = 'performance-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 60px;
                    right: 20px;
                    padding: 4px 12px;
                    border-radius: 15px;
                    background: rgba(16, 185, 129, 0.2);
                    color: #10b981;
                    font-size: 11px;
                    z-index: 1000;
                `;
                document.body.appendChild(indicator);
                return indicator;
            }
            
            handleRealTimeMessage(messageData) {
                // Handle real-time incoming messages
                if (messageData.type === 'tool_call') {
                    this.visualizeToolCall(messageData);
                } else if (messageData.type === 'reasoning') {
                    this.addReasoningStep(messageData);
                } else {
                    this.addMessage(messageData.content, false);
                }
            }
            
            visualizeToolCall(toolCallData) {
                // Create enhanced tool call visualization
                const toolCallElement = document.createElement('div');
                toolCallElement.className = 'tool-call enhanced';
                toolCallElement.innerHTML = `
                    <div class="tool-header">
                        <span class="tool-icon">üîß</span>
                        <span class="tool-name">${toolCallData.tool_name}</span>
                        <span class="tool-status ${toolCallData.status}">${toolCallData.status}</span>
                        <span class="tool-timestamp">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="tool-content">
                        <div class="tool-input">
                            <strong>Input:</strong>
                            <pre>${JSON.stringify(toolCallData.input, null, 2)}</pre>
                        </div>
                        ${toolCallData.output ? `
                            <div class="tool-output">
                                <strong>Output:</strong>
                                <pre>${JSON.stringify(toolCallData.output, null, 2)}</pre>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.appendChild(toolCallElement);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
            
            addReasoningStep(stepData) {
                // Add reasoning step visualization
                const reasoningElement = document.createElement('div');
                reasoningElement.className = 'reasoning-step';
                reasoningElement.innerHTML = `
                    <div style="background: rgba(139, 92, 246, 0.1); border-left: 3px solid #8b5cf6; 
                                padding: 12px; margin: 8px 0; border-radius: 0 8px 8px 0;">
                        <strong>üß† Reasoning:</strong> ${stepData.step}
                        ${stepData.confidence ? `<span style="float: right; color: #8b5cf6;">${Math.round(stepData.confidence * 100)}%</span>` : ''}
                    </div>
                `;
                
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.appendChild(reasoningElement);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
            
            showRecommendation(recommendation) {
                // Show AI recommendation with enhanced styling
                this.addSystemMessage(`üí° **AI Recommendation:** ${recommendation.message}`, 'recommendation');
            }
            
            addSystemMessage(message, type = 'info') {
                const colors = {
                    info: '#06b6d4',
                    recommendation: '#10b981',
                    warning: '#f59e0b',
                    error: '#ef4444'
                };
                
                const messageElement = document.createElement('div');
                messageElement.className = `system-message ${type}`;
                messageElement.innerHTML = `
                    <div style="background: rgba(${this.hexToRgb(colors[type])}, 0.1); 
                                border: 1px solid ${colors[type]}; 
                                border-radius: 8px; padding: 12px; margin: 8px 0; 
                                color: ${colors[type]};">
                        ${message}
                    </div>
                `;
                
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.appendChild(messageElement);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
            
            hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? 
                    `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : 
                    '255, 255, 255';
            }
        }
        
        // Initialize Modern Chat Component
        document.addEventListener('DOMContentLoaded', () => {
            window.modernChatComponent = new ModernChatComponent();
            console.log('üöÄ Modern Chat Component initialized with real-time state management');
            
            // Initialize development tools
            initializeDevTools();
            
            // Add DEV MODE indicator to title
            document.title = "[DEV] " + document.title;
        });
        
        // Development mode settings
        const devMode = {
            showRawResponses: false,
            showTimings: false,
            selectedEndpoint: '/chat/stream',
            networkLogs: []
        };
        
        // Development Tools Functions
        function initializeDevTools() {
            // Toggle dev tools panel
            document.getElementById('toggleDevTools').addEventListener('click', () => {
                const panel = document.getElementById('devToolsPanel');
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            });
            
            // Close dev tools panel
            document.getElementById('closeDevTools').addEventListener('click', () => {
                document.getElementById('devToolsPanel').style.display = 'none';
            });
            
            // Endpoint selection
            document.getElementById('endpointSelect').addEventListener('change', (e) => {
                devMode.selectedEndpoint = e.target.value;
                console.log(`[DEV] Endpoint changed to: ${devMode.selectedEndpoint}`);
            });
            
            // Test endpoint
            document.getElementById('testEndpoint').addEventListener('click', async () => {
                const endpoint = devMode.selectedEndpoint;
                logNetworkRequest('TEST', endpoint, 'Testing endpoint');
                
                try {
                    const startTime = performance.now();
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: "TEST_MESSAGE_FROM_DEV_TOOLS",
                            user_id: "dev_test_user",
                            stream: endpoint === '/chat/stream'
                        })
                    });
                    
                    const endTime = performance.now();
                    const duration = Math.round(endTime - startTime);
                    
                    if (response.ok) {
                        if (endpoint === '/chat/stream') {
                            logNetworkRequest('SUCCESS', endpoint, `Stream connection established (${duration}ms)`);
                        } else {
                            const data = await response.json();
                            logNetworkRequest('SUCCESS', endpoint, `Response received (${duration}ms): ${JSON.stringify(data).substring(0, 100)}...`);
                        }
                    } else {
                        logNetworkRequest('ERROR', endpoint, `Error ${response.status}: ${response.statusText} (${duration}ms)`);
                    }
                } catch (error) {
                    logNetworkRequest('ERROR', endpoint, `Exception: ${error.message}`);
                }
            });
            
            // Debug options
            document.getElementById('showRawResponse').addEventListener('change', (e) => {
                devMode.showRawResponses = e.target.checked;
                console.log(`[DEV] Show raw responses: ${devMode.showRawResponses}`);
            });
            
            document.getElementById('showTimings').addEventListener('change', (e) => {
                devMode.showTimings = e.target.checked;
                console.log(`[DEV] Show timings: ${devMode.showTimings}`);
            });
            
            // WebSocket testing
            document.getElementById('testWebSocket').addEventListener('click', () => {
                // Test WebSocket connection
                const ws = new WebSocket(`ws://${window.location.host}/ws`);
                
                ws.onopen = () => {
                    document.getElementById('wsStatus').textContent = 'WebSocket: Connected';
                    document.getElementById('wsStatus').style.color = '#10b981';
                    logNetworkRequest('WS', '/ws', 'WebSocket connection established');
                };
                
                ws.onclose = () => {
                    document.getElementById('wsStatus').textContent = 'WebSocket: Disconnected';
                    document.getElementById('wsStatus').style.color = '#ef4444';
                    logNetworkRequest('WS', '/ws', 'WebSocket connection closed');
                };
                
                ws.onerror = (error) => {
                    document.getElementById('wsStatus').textContent = 'WebSocket: Error';
                    document.getElementById('wsStatus').style.color = '#ef4444';
                    logNetworkRequest('WS_ERROR', '/ws', `WebSocket error: ${error.message || 'Unknown error'}`);
                };
                
                // Close after 5 seconds
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.close();
                    }
                }, 5000);
            });
            
            // Send test event
            document.getElementById('sendTestEvent').addEventListener('click', () => {
                // Create a test event
                const testEvent = {
                    type: 'TEST_EVENT',
                    data: {
                        message: 'This is a test event from the dev tools',
                        timestamp: new Date().toISOString()
                    }
                };
                
                // Send via fetch to a test endpoint
                fetch('/api/test/event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testEvent)
                })
                .then(response => {
                    if (response.ok) {
                        logNetworkRequest('EVENT', '/api/test/event', 'Test event sent successfully');
                    } else {
                        logNetworkRequest('EVENT_ERROR', '/api/test/event', `Error ${response.status}: ${response.statusText}`);
                    }
                })
                .catch(error => {
                    logNetworkRequest('EVENT_ERROR', '/api/test/event', `Exception: ${error.message}`);
                });
            });
            
            // Clear network log
            document.getElementById('clearNetworkLog').addEventListener('click', () => {
                devMode.networkLogs = [];
                document.getElementById('networkLog').innerHTML = '<div>No requests logged yet</div>';
            });
        }
        
        // Log network request to dev tools
        function logNetworkRequest(type, url, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { type, url, message, timestamp };
            
            devMode.networkLogs.push(logEntry);
            
            // Keep only the last 50 logs
            if (devMode.networkLogs.length > 50) {
                devMode.networkLogs.shift();
            }
            
            // Update the log display
            const networkLog = document.getElementById('networkLog');
            
            // Clear if this is the first entry
            if (networkLog.textContent.includes('No requests logged yet')) {
                networkLog.innerHTML = '';
            }
            
            // Create log entry
            const entryDiv = document.createElement('div');
            entryDiv.style.borderBottom = '1px solid #374151';
            entryDiv.style.paddingBottom = '4px';
            entryDiv.style.marginBottom = '4px';
            
            // Set color based on type
            let typeColor = '#a0a0a0';
            if (type.includes('ERROR')) typeColor = '#ef4444';
            if (type === 'SUCCESS') typeColor = '#10b981';
            
            entryDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: ${typeColor};">${type}</span>
                    <span style="opacity: 0.7;">${timestamp}</span>
                </div>
                <div style="font-weight: bold;">${url}</div>
                <div style="word-break: break-all;">${message}</div>
            `;
            
            networkLog.appendChild(entryDiv);
            networkLog.scrollTop = networkLog.scrollHeight;
        }
        
        // Override fetch for network logging in dev mode
        const originalFetch = window.fetch;
        window.fetch = async function(url, options) {
            const startTime = performance.now();
            
            // Log the request
            if (devMode.showTimings) {
                logNetworkRequest('REQUEST', url, `Method: ${options?.method || 'GET'}`);
            }
            
            try {
                const response = await originalFetch(url, options);
                
                // Log the response
                if (devMode.showTimings) {
                    const endTime = performance.now();
                    const duration = Math.round(endTime - startTime);
                    logNetworkRequest('RESPONSE', url, `Status: ${response.status} (${duration}ms)`);
                }
                
                return response;
            } catch (error) {
                // Log the error
                if (devMode.showTimings) {
                    logNetworkRequest('FETCH_ERROR', url, `Error: ${error.message}`);
                }
                throw error;
            }
        };
    </script>
</body>
</html>
