<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIS Protocol - Modern Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0A0A0B;
            color: white;
            overflow-x: hidden;
            height: 100vh;
        }

        .chat-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        /* Animated Background */
        .bg-gradient {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }

        .bg-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(128px);
            mix-blend-mode: normal;
            animation: pulse 4s ease-in-out infinite;
        }

        .bg-orb:nth-child(1) {
            top: 0;
            left: 25%;
            width: 384px;
            height: 384px;
            background: rgba(139, 92, 246, 0.1);
            animation-delay: 0s;
        }

        .bg-orb:nth-child(2) {
            bottom: 0;
            right: 25%;
            width: 384px;
            height: 384px;
            background: rgba(99, 102, 241, 0.1);
            animation-delay: 0.7s;
        }

        .bg-orb:nth-child(3) {
            top: 25%;
            right: 33%;
            width: 256px;
            height: 256px;
            background: rgba(217, 70, 239, 0.1);
            filter: blur(96px);
            animation-delay: 1s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .main-content {
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 48px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease-out forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            animation: fadeInUp 0.5s ease-out 0.2s both;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 500;
            letter-spacing: -0.025em;
            background: linear-gradient(to right, rgba(255,255,255,0.9), rgba(255,255,255,0.4));
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            margin-bottom: 8px;
        }

        .header-line {
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent);
            width: 0;
            margin: 0 auto 12px;
            animation: expandLine 0.8s ease-out 0.5s both;
        }

        @keyframes expandLine {
            to { width: 100%; }
        }

        .header p {
            font-size: 0.875rem;
            color: rgba(255,255,255,0.4);
            opacity: 0;
            animation: fadeIn 0.5s ease-out 0.3s both;
        }

        .chat-toggle-container {
            margin-top: 16px;
            opacity: 0;
            animation: fadeIn 0.5s ease-out 0.4s both;
        }

        .classic-chat-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .classic-chat-link:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.9);
            transform: translateY(-1px);
        }

        .classic-chat-link span {
            font-size: 0.9rem;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* Chat Box */
        .chat-box {
            backdrop-filter: blur(32px);
            background: rgba(255,255,255,0.02);
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);
            position: relative;
            transform: scale(0.98);
            animation: scaleIn 0.5s ease-out 0.1s both;
        }

        @keyframes scaleIn {
            to { transform: scale(1); }
        }

        /* Command Palette */
        .command-palette {
            position: absolute;
            left: 16px;
            right: 16px;
            bottom: 100%;
            margin-bottom: 8px;
            backdrop-filter: blur(24px);
            background: rgba(0,0,0,0.9);
            border-radius: 8px;
            z-index: 50;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
            display: none;
            opacity: 0;
            transform: translateY(5px);
            transition: all 0.15s ease-out;
        }

        .command-palette.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .command-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            cursor: pointer;
            color: rgba(255,255,255,0.7);
        }

        .command-item:hover,
        .command-item.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .command-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.6);
        }

        .command-prefix {
            color: rgba(255,255,255,0.4);
            font-size: 0.75rem;
            margin-left: 4px;
        }

        /* Text Area */
        .input-container {
            padding: 16px;
        }

        .chat-textarea {
            width: 100%;
            min-height: 60px;
            max-height: 200px;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.9);
            font-size: 0.875rem;
            resize: none;
            outline: none;
            font-family: inherit;
            line-height: 1.5;
        }

        .chat-textarea::placeholder {
            color: rgba(255,255,255,0.2);
        }

        .textarea-ring {
            position: absolute;
            inset: 0;
            border-radius: 8px;
            pointer-events: none;
            border: 2px solid rgba(139, 92, 246, 0.3);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .chat-textarea:focus + .textarea-ring {
            opacity: 1;
        }

        /* Attachments */
        .attachments {
            padding: 0 16px 12px;
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .attachments.show {
            display: flex;
            opacity: 1;
            max-height: 200px;
        }

        .attachment {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            background: rgba(255,255,255,0.03);
            padding: 6px 12px;
            border-radius: 8px;
            color: rgba(255,255,255,0.7);
            animation: fadeInScale 0.3s ease;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .attachment-remove {
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .attachment-remove:hover {
            color: white;
        }

        /* Controls */
        .chat-controls {
            padding: 16px;
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .control-buttons {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-btn {
            padding: 8px;
            color: rgba(255,255,255,0.4);
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .control-btn:hover {
            color: rgba(255,255,255,0.9);
            background: rgba(255,255,255,0.05);
        }

        .control-btn.active {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.9);
        }

        .send-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .send-btn:disabled {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.4);
            cursor: not-allowed;
        }

        .send-btn:not(:disabled) {
            background: white;
            color: #0A0A0B;
            box-shadow: 0 4px 8px rgba(255,255,255,0.1);
        }

        .send-btn:not(:disabled):hover {
            transform: scale(1.01);
        }

        .send-btn:not(:disabled):active {
            transform: scale(0.98);
        }

        /* Command Suggestions */
        .command-suggestions {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 8px;
            animation: fadeInUp 0.5s ease-out;
        }

        .suggestion-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
            font-size: 0.875rem;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.5s ease-out forwards;
        }

        .suggestion-btn:nth-child(1) { animation-delay: 0s; }
        .suggestion-btn:nth-child(2) { animation-delay: 0.1s; }
        .suggestion-btn:nth-child(3) { animation-delay: 0.2s; }
        .suggestion-btn:nth-child(4) { animation-delay: 0.3s; }

        .suggestion-btn:hover {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.9);
            transform: translateY(-2px);
        }

        /* Typing Indicator */
        .typing-indicator {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            backdrop-filter: blur(32px);
            background: rgba(255,255,255,0.02);
            border-radius: 9999px;
            padding: 8px 16px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
            display: none;
            align-items: center;
            gap: 12px;
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
            transition: all 0.3s ease;
        }

        .typing-indicator.show {
            display: flex;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .typing-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 500;
            color: rgba(255,255,255,0.9);
        }

        .typing-text {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            color: rgba(255,255,255,0.7);
        }

        .typing-dots {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(255,255,255,0.3);
            animation: typingDot 1.2s ease-in-out infinite;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.15s; }
        .typing-dot:nth-child(3) { animation-delay: 0.3s; }

        @keyframes typingDot {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: scale(0.85);
            }
            30% {
                opacity: 0.9;
                transform: scale(1.1);
            }
        }

        /* Focus glow effect */
        .focus-glow {
            position: fixed;
            width: 800px;
            height: 800px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.02;
            background: linear-gradient(to right, rgb(139, 92, 246), rgb(217, 70, 239), rgb(99, 102, 241));
            filter: blur(96px);
            transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1);
            display: none;
        }

        .focus-glow.active {
            display: block;
        }

        /* Chat Messages Area */
        .chat-messages {
            flex: 1;
            max-height: 400px;
            overflow-y: auto;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }

        .chat-messages.show {
            display: block;
        }

        /* Terminal Integration */
        .terminal-section {
            border-top: 1px solid rgba(255,255,255,0.05);
            background: rgba(0,0,0,0.3);
            border-radius: 0 0 16px 16px;
            display: none;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .terminal-section.show {
            display: block;
            opacity: 1;
            max-height: 300px;
        }

        .terminal-header {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0,0,0,0.2);
        }

        .terminal-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            color: rgba(255,255,255,0.7);
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        }

        .terminal-controls {
            display: flex;
            gap: 8px;
        }

        .terminal-btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .terminal-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .terminal-output {
            padding: 16px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.75rem;
            line-height: 1.4;
            color: rgba(255,255,255,0.8);
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0,0,0,0.4);
        }

        .terminal-input-container {
            padding: 12px 16px;
            background: rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal-prompt {
            color: rgba(99, 102, 241, 0.8);
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.75rem;
        }

        .terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.75rem;
            outline: none;
        }

        .terminal-input::placeholder {
            color: rgba(255,255,255,0.3);
        }

        /* Code Block Styling */
        .code-block {
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.75rem;
            line-height: 1.4;
            position: relative;
        }

        .code-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .code-language {
            color: rgba(99, 102, 241, 0.8);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .code-actions {
            display: flex;
            gap: 4px;
        }

        .code-action-btn {
            padding: 2px 6px;
            font-size: 0.6rem;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 3px;
            color: rgba(255,255,255,0.6);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .code-action-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .message {
            margin-bottom: 16px;
            animation: messageSlideIn 0.3s ease;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-user {
            text-align: right;
        }

        .message-bubble {
            display: inline-block;
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .message-user .message-bubble {
            background: rgba(139, 92, 246, 0.2);
            color: white;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .message-assistant {
            text-align: left;
        }

        .message-assistant .message-bubble {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.9);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .message-time {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.4);
            margin-top: 4px;
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .chat-container {
                padding: 16px;
            }
            
            .main-content {
                gap: 32px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .command-suggestions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Animated Background -->
        <div class="bg-gradient">
            <div class="bg-orb"></div>
            <div class="bg-orb"></div>
            <div class="bg-orb"></div>
        </div>

        <!-- Focus Glow Effect -->
        <div class="focus-glow" id="focusGlow"></div>

        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h1>How can I help today?</h1>
                <div class="header-line"></div>
                <p>Type a command or ask a question</p>
                <div class="chat-toggle-container">
                    <a href="/console" class="classic-chat-link">
                        <span>🔄</span>
                        Switch to Classic Chat
                    </a>
                </div>
            </div>

            <!-- Chat Box -->
            <div class="chat-box">
                <!-- Command Palette -->
                <div class="command-palette" id="commandPalette">
                    <div class="command-item" data-prefix="/clone" data-label="Clone UI">
                        <div class="command-icon">🖼️</div>
                        <div>Clone UI</div>
                        <div class="command-prefix">/clone</div>
                    </div>
                    <div class="command-item" data-prefix="/figma" data-label="Import Figma">
                        <div class="command-icon">🎨</div>
                        <div>Import Figma</div>
                        <div class="command-prefix">/figma</div>
                    </div>
                    <div class="command-item" data-prefix="/page" data-label="Create Page">
                        <div class="command-icon">📄</div>
                        <div>Create Page</div>
                        <div class="command-prefix">/page</div>
                    </div>
                    <div class="command-item" data-prefix="/improve" data-label="Improve">
                        <div class="command-icon">✨</div>
                        <div>Improve</div>
                        <div class="command-prefix">/improve</div>
                    </div>
                    <div class="command-item" data-prefix="/run" data-label="Run Code">
                        <div class="command-icon">🔧</div>
                        <div>Run Code</div>
                        <div class="command-prefix">/run</div>
                    </div>
                    <div class="command-item" data-prefix="/python" data-label="Python Script">
                        <div class="command-icon">🐍</div>
                        <div>Python Script</div>
                        <div class="command-prefix">/python</div>
                    </div>
                    <div class="command-item" data-prefix="/terminal" data-label="Terminal">
                        <div class="command-icon">💻</div>
                        <div>Terminal</div>
                        <div class="command-prefix">/terminal</div>
                    </div>
                    <div class="command-item" data-prefix="/file" data-label="File Operations">
                        <div class="command-icon">📁</div>
                        <div>File Operations</div>
                        <div class="command-prefix">/file</div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages" id="chatMessages"></div>

                <!-- Input Container -->
                <div class="input-container">
                    <div style="position: relative;">
                        <textarea 
                            id="chatInput" 
                            class="chat-textarea" 
                            placeholder="Ask zap a question..."
                            rows="1"
                        ></textarea>
                        <div class="textarea-ring"></div>
                    </div>
                </div>

                <!-- Attachments -->
                <div class="attachments" id="attachments"></div>

                <!-- Controls -->
                <div class="chat-controls">
                    <div class="control-buttons">
                        <button class="control-btn" id="attachBtn" title="Attach file">
                            📎
                        </button>
                        <button class="control-btn" id="commandBtn" title="Commands">
                            ⌘
                        </button>
                        <button class="control-btn" id="runnerBtn" title="Runner Terminal">
                            🔧
                        </button>
                    </div>
                    <button class="send-btn" id="sendBtn" disabled>
                        <span id="sendIcon">📤</span>
                        <span>Send</span>
                    </button>
                    <button class="control-btn" id="terminalBtn" title="Terminal">
                        💻
                    </button>
                </div>
            </div>

            <!-- Terminal Section -->
            <div class="terminal-section" id="terminalSection">
                <div class="terminal-header">
                    <div class="terminal-title">
                        <span>🔧</span>
                        <span>NIS Runner Terminal</span>
                    </div>
                    <div class="terminal-controls">
                        <button class="terminal-btn" id="clearTerminal">Clear</button>
                        <button class="terminal-btn" id="closeTerminal">Close</button>
                    </div>
                </div>
                <div class="terminal-output" id="terminalOutput">
                    <div style="color: rgba(99, 102, 241, 0.8);">NIS Protocol Runner v1.0.0</div>
                    <div style="color: rgba(255,255,255,0.6);">Secure execution environment ready.</div>
                    <div style="color: rgba(255,255,255,0.4);">Type 'help' for available commands.</div>
                </div>
                <div class="terminal-input-container">
                    <span class="terminal-prompt">runner $</span>
                    <input type="text" class="terminal-input" id="terminalInput" placeholder="Enter command...">
                </div>
            </div>
        </div>

            <!-- Command Suggestions -->
            <div class="command-suggestions">
                <button class="suggestion-btn" data-command="/run">
                    <span>🔧</span>
                    <span>Run Code</span>
                </button>
                <button class="suggestion-btn" data-command="/python">
                    <span>🐍</span>
                    <span>Python Script</span>
                </button>
                <button class="suggestion-btn" data-command="/terminal">
                    <span>💻</span>
                    <span>Terminal</span>
                </button>
                <button class="suggestion-btn" data-command="/file">
                    <span>📁</span>
                    <span>File Ops</span>
                </button>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-avatar">AI</div>
            <div class="typing-text">
                <span>Thinking</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let attachments = [];
        let activeSuggestion = -1;
        let isTyping = false;
        let currentController = null;

        // DOM elements
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const attachBtn = document.getElementById('attachBtn');
        const commandBtn = document.getElementById('commandBtn');
        const commandPalette = document.getElementById('commandPalette');
        const attachmentsContainer = document.getElementById('attachments');
        const typingIndicator = document.getElementById('typingIndicator');
        const focusGlow = document.getElementById('focusGlow');
        const chatMessages = document.getElementById('chatMessages');
        const sendIcon = document.getElementById('sendIcon');

        // Auto-resize textarea
        function adjustTextareaHeight() {
            chatInput.style.height = '60px';
            const newHeight = Math.max(60, Math.min(chatInput.scrollHeight, 200));
            chatInput.style.height = newHeight + 'px';
        }

        // Show/hide command palette
        function showCommandPalette() {
            commandPalette.classList.add('show');
            updateActiveSuggestion();
        }

        function hideCommandPalette() {
            commandPalette.classList.remove('show');
            activeSuggestion = -1;
        }

        // Update active command suggestion
        function updateActiveSuggestion() {
            const items = commandPalette.querySelectorAll('.command-item');
            items.forEach((item, index) => {
                item.classList.toggle('active', index === activeSuggestion);
            });
        }

        // Apply command from palette
        function applyCommand(prefix) {
            chatInput.value = prefix + ' ';
            hideCommandPalette();
            chatInput.focus();
            adjustTextareaHeight();
            updateSendButton();
        }

        // Update send button state
        function updateSendButton() {
            const hasText = chatInput.value.trim().length > 0;
            sendBtn.disabled = !hasText || isTyping;
        }

        // Add attachment
        function addAttachment() {
            const fileName = `file-${Math.floor(Math.random() * 1000)}.pdf`;
            attachments.push(fileName);
            renderAttachments();
        }

        // Remove attachment
        function removeAttachment(index) {
            attachments.splice(index, 1);
            renderAttachments();
        }

        // Render attachments
        function renderAttachments() {
            attachmentsContainer.innerHTML = '';
            if (attachments.length > 0) {
                attachmentsContainer.classList.add('show');
                attachments.forEach((file, index) => {
                    const attachment = document.createElement('div');
                    attachment.className = 'attachment';
                    attachment.innerHTML = `
                        <span>${file}</span>
                        <span class="attachment-remove" onclick="removeAttachment(${index})">✕</span>
                    `;
                    attachmentsContainer.appendChild(attachment);
                });
            } else {
                attachmentsContainer.classList.remove('show');
            }
        }

        // Add message to chat
        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.classList.add('show');
            
            const message = document.createElement('div');
            message.className = `message ${isUser ? 'message-user' : 'message-assistant'}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = content;
            
            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = new Date().toLocaleTimeString();
            
            message.appendChild(bubble);
            message.appendChild(time);
            messagesContainer.appendChild(message);
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Show typing indicator
        function showTyping() {
            isTyping = true;
            typingIndicator.classList.add('show');
            updateSendButton();
        }

        // Hide typing indicator
        function hideTyping() {
            isTyping = false;
            typingIndicator.classList.remove('show');
            updateSendButton();
        }

        // Execute runner command
        async function executeRunnerCommand(command) {
            try {
                const response = await fetch('/tools/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tool: "run_shell",
                        args: { cmd: command, timeout: 30 }
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    const output = result.stdout || 'Command executed successfully';
                    addMessage(`🔧 Runner: ${command}\n\`\`\`\n${output}\n\`\`\``, false);
                } else {
                    const error = result.error || result.stderr || 'Command failed';
                    addMessage(`❌ Runner Error: ${command}\n\`\`\`\n${error}\n\`\`\``, false);
                }
            } catch (error) {
                addMessage(`🚨 Runner Connection Error: ${error.message}`, false);
            }
        }

        // Execute Python script
        async function executePythonScript(filename, content) {
            try {
                // First, write the script
                await fetch('/tools/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tool: "write_script",
                        args: { filename: filename, content: content }
                    })
                });

                // Then execute it
                const response = await fetch('/tools/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tool: "run_python",
                        args: { filepath: filename, timeout: 60 }
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    const output = result.stdout || 'Script executed successfully';
                    addMessage(`🐍 Python: ${filename}\n\`\`\`\n${output}\n\`\`\``, false);
                } else {
                    const error = result.error || result.stderr || 'Script failed';
                    addMessage(`❌ Python Error: ${filename}\n\`\`\`\n${error}\n\`\`\``, false);
                }
            } catch (error) {
                addMessage(`🚨 Python Execution Error: ${error.message}`, false);
            }
        }

        // Send message with streaming
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || isTyping) return;

            // Check for runner commands
            if (message.startsWith('/run ')) {
                const command = message.substring(5);
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                await executeRunnerCommand(command);
                return;
            }

            if (message.startsWith('/python ')) {
                const code = message.substring(8);
                const filename = `script_${Date.now()}.py`;
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                await executePythonScript(filename, code);
                return;
            }

            // File operations
            if (message === '/files') {
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('list_files', {});
                    const files = result.files || [];
                    const fileList = files.map(f => `${f.type === 'directory' ? '📁' : '📄'} ${f.name} (${f.size} bytes)`).join('\n');
                    addMessage(`📁 Workspace Files:\n\`\`\`\n${fileList || 'No files found'}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`❌ Error: ${error.message}`, false);
                }
                return;
            }

            if (message.startsWith('/read ')) {
                const filename = message.substring(6);
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('read_file', { filepath: filename });
                    addMessage(`📄 File: ${filename}\n\`\`\`\n${result.content}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`❌ Error reading file: ${error.message}`, false);
                }
                return;
            }

            if (message.startsWith('/mkdir ')) {
                const dirname = message.substring(7);
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('create_directory', { path: dirname });
                    addMessage(`✅ Directory created: ${result.path}`, false);
                } catch (error) {
                    addMessage(`❌ Error creating directory: ${error.message}`, false);
                }
                return;
            }

            if (message.startsWith('/delete ')) {
                const filename = message.substring(8);
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('delete_file', { filepath: filename });
                    addMessage(`🗑️ File deleted: ${result.deleted}`, false);
                } catch (error) {
                    addMessage(`❌ Error deleting file: ${error.message}`, false);
                }
                return;
            }

            // System info commands
            if (message === '/sysinfo') {
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('system_info', {});
                    const info = result.system_info;
                    addMessage(`💻 System Information:\n\`\`\`\nPlatform: ${info.platform}\nPython: ${info.python_version}\nCPU Cores: ${info.cpu_count}\nMemory: ${(info.memory_available / 1024 / 1024 / 1024).toFixed(2)} GB available\nDisk Usage: ${info.disk_usage}%\nWorkspace: ${info.workspace}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`❌ Error getting system info: ${error.message}`, false);
                }
                return;
            }

            if (message === '/disk') {
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('disk_usage', {});
                    const disk = result.disk_usage;
                    addMessage(`💽 Disk Usage:\n\`\`\`\nTotal: ${(disk.total / 1024 / 1024 / 1024).toFixed(2)} GB\nUsed: ${(disk.used / 1024 / 1024 / 1024).toFixed(2)} GB\nFree: ${(disk.free / 1024 / 1024 / 1024).toFixed(2)} GB\nUsage: ${disk.percent_used.toFixed(1)}%\n\`\`\``, false);
                } catch (error) {
                    addMessage(`❌ Error getting disk usage: ${error.message}`, false);
                }
                return;
            }

            if (message === '/processes') {
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('process_list', {});
                    const processes = result.processes.slice(0, 10);
                    const processList = processes.map(p => `${p.pid}: ${p.name} (${p.cpu_percent}% CPU)`).join('\n');
                    addMessage(`⚙️ Running Processes (Top 10):\n\`\`\`\n${processList}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`❌ Error getting processes: ${error.message}`, false);
                }
                return;
            }

            // Advanced tools
            if (message === '/report') {
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('generate_report', {});
                    addMessage(`📊 System Report Generated:\n\`\`\`\nSaved to: ${result.saved_to}\nGenerated: ${result.report.generated_at}\nFiles in workspace: ${result.report.workspace_files.length}\nRecent executions: ${result.report.execution_log.length}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`❌ Error generating report: ${error.message}`, false);
                }
                return;
            }

            if (message === '/backup') {
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('backup_workspace', {});
                    addMessage(`💾 Workspace Backup Created:\n\`\`\`\nFile: ${result.backup_file}\nSize: ${(result.size / 1024).toFixed(2)} KB\nCreated: ${result.created_at}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`❌ Error creating backup: ${error.message}`, false);
                }
                return;
            }

            if (message.startsWith('/network') || message === '/network') {
                const host = message.includes(' ') ? message.split(' ')[1] : 'google.com';
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('network_test', { host: host });
                    addMessage(`🌐 Network Test (${result.host}):\n\`\`\`\nStatus: ${result.response_time}\nConnectivity: ${result.success ? '✅ Online' : '❌ Offline'}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`❌ Network test error: ${error.message}`, false);
                }
                return;
            }

            if (message === '/git') {
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('git_status', {});
                    if (result.is_git_repo) {
                        addMessage(`🔄 Git Status:\n\`\`\`\n${result.clean ? 'Working directory clean' : result.status}\n\`\`\``, false);
                    } else {
                        addMessage(`📁 Not a git repository`, false);
                    }
                } catch (error) {
                    addMessage(`❌ Git error: ${error.message}`, false);
                }
                return;
            }

            if (message.startsWith('/install ')) {
                const package = message.substring(9);
                addMessage(message, true);
                chatInput.value = '';
                adjustTextareaHeight();
                updateSendButton();
                try {
                    const result = await executeRunnerTool('install_package', { package: package });
                    addMessage(`📦 Package Installation:\n\`\`\`\nPackage: ${result.package}\nStatus: ${result.success ? '✅ Installed' : '❌ Failed'}\n${result.output || result.error}\n\`\`\``, false);
                } catch (error) {
                    addMessage(`❌ Installation error: ${error.message}`, false);
                }
                return;
            }

            // Add user message
            addMessage(message, true);
            
            // Clear input
            chatInput.value = '';
            attachments = [];
            renderAttachments();
            adjustTextareaHeight();
            updateSendButton();

            // Show typing indicator
            showTyping();
            sendIcon.textContent = '⏳';

            // Cancel any existing stream
            if (currentController) {
                currentController.abort();
            }

            currentController = new AbortController();

            try {
                const response = await fetch('/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        user_id: 'user_' + Date.now(),
                        agent_type: 'reasoning',
                        provider: 'anthropic'
                    }),
                    signal: currentController.signal
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                let assistantMessage = '';
                let messageElement = null;
                
                // Hide typing indicator and create initial message
                hideTyping();
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message message-assistant';
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = '';
                
                const time = document.createElement('div');
                time.className = 'message-time';
                time.textContent = new Date().toLocaleTimeString();
                
                messageDiv.appendChild(bubble);
                messageDiv.appendChild(time);
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = new TextDecoder().decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.type === 'content') {
                                    assistantMessage += data.data;
                                    bubble.textContent = assistantMessage;
                                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                }
                            } catch (e) {
                                // Ignore JSON parse errors
                            }
                        }
                    }
                }

            } catch (error) {
                hideTyping();
                if (error.name !== 'AbortError') {
                    addMessage('Sorry, I encountered an error. Please try again.', false);
                    console.error('Chat error:', error);
                }
            } finally {
                sendIcon.textContent = '📤';
                currentController = null;
            }
        }

        // Mouse tracking for focus glow
        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            if (document.activeElement === chatInput) {
                focusGlow.style.transform = `translate(${mouseX - 400}px, ${mouseY - 400}px)`;
            }
        });

        // Event listeners
        chatInput.addEventListener('input', (e) => {
            adjustTextareaHeight();
            updateSendButton();
            
            const value = e.target.value;
            if (value.startsWith('/') && !value.includes(' ')) {
                showCommandPalette();
                
                const items = commandPalette.querySelectorAll('.command-item');
                let foundIndex = -1;
                items.forEach((item, index) => {
                    const prefix = item.getAttribute('data-prefix');
                    if (prefix.startsWith(value)) {
                        foundIndex = index;
                    }
                });
                activeSuggestion = foundIndex;
                updateActiveSuggestion();
            } else {
                hideCommandPalette();
            }
        });

        chatInput.addEventListener('focus', () => {
            focusGlow.classList.add('active');
        });

        chatInput.addEventListener('blur', () => {
            focusGlow.classList.remove('active');
        });

        chatInput.addEventListener('keydown', (e) => {
            if (commandPalette.classList.contains('show')) {
                const items = commandPalette.querySelectorAll('.command-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    activeSuggestion = activeSuggestion < items.length - 1 ? activeSuggestion + 1 : 0;
                    updateActiveSuggestion();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    activeSuggestion = activeSuggestion > 0 ? activeSuggestion - 1 : items.length - 1;
                    updateActiveSuggestion();
                } else if (e.key === 'Tab' || e.key === 'Enter') {
                    e.preventDefault();
                    if (activeSuggestion >= 0) {
                        const selectedItem = items[activeSuggestion];
                        applyCommand(selectedItem.getAttribute('data-prefix'));
                    }
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    hideCommandPalette();
                }
            } else if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);
        attachBtn.addEventListener('click', addAttachment);
        
        commandBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (commandPalette.classList.contains('show')) {
                hideCommandPalette();
            } else {
                chatInput.value = '/';
                chatInput.focus();
                showCommandPalette();
            }
        });

        // Enhanced runner commands
        async function executeRunnerTool(tool, args) {
            try {
                const response = await fetch('/tools/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ tool: tool, args: args })
                });

                const result = await response.json();
                
                if (result.success) {
                    return result;
                } else {
                    throw new Error(result.error || 'Tool execution failed');
                }
            } catch (error) {
                throw error;
            }
        }

        // Runner button functionality
        const runnerBtn = document.getElementById('runnerBtn');
        runnerBtn.addEventListener('click', () => {
            addMessage(`🔧 **NIS Runner Terminal Ready!**

**📁 File Operations:**
• \`/files\` - List all files
• \`/read filename.txt\` - Read file content
• \`/mkdir dirname\` - Create directory
• \`/delete filename.txt\` - Delete file

**🐍 Python & Scripts:**
• \`/python print("hello")\` - Run Python code
• \`/install numpy\` - Install Python packages

**💻 System Commands:**
• \`/run ls -la\` - Shell commands
• \`/sysinfo\` - System information
• \`/processes\` - Running processes
• \`/disk\` - Disk usage

**🔧 Advanced Tools:**
• \`/report\` - Generate system report
• \`/backup\` - Backup workspace
• \`/network\` - Test connectivity
• \`/git\` - Git status

**Type any command to get started!** 🚀`, false);
        });

        // Command palette click handlers
        commandPalette.addEventListener('click', (e) => {
            const item = e.target.closest('.command-item');
            if (item) {
                applyCommand(item.getAttribute('data-prefix'));
            }
        });

        // Suggestion button handlers
        document.querySelectorAll('.suggestion-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const command = btn.getAttribute('data-command');
                applyCommand(command);
            });
        });

        // Click outside to hide command palette
        document.addEventListener('click', (e) => {
            if (!commandPalette.contains(e.target) && !commandBtn.contains(e.target)) {
                hideCommandPalette();
            }
        });

        // Initial setup
        adjustTextareaHeight();
        updateSendButton();
        
        // Welcome message
        setTimeout(() => {
            addMessage('Hello! I\'m your AI assistant. Type a command starting with "/" or ask me anything.', false);
        }, 1000);
    </script>
</body>
</html>
