<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIS Protocol v3 - Real-Time Performance Dashboard</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .metric-card {
            transition: all 0.3s ease;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .normal { border-left: 5px solid #28a745; }
        .warning { border-left: 5px solid #ffc107; }
        .critical { border-left: 5px solid #dc3545; }
        .metric-value { 
            font-size: 2rem; 
            font-weight: bold; 
            color: #2c3e50;
        }
        .metric-target { 
            color: #666; 
            font-size: 0.9rem;
        }
        .evidence-link { 
            color: #007bff; 
            text-decoration: none; 
            font-weight: 500;
        }
        .evidence-link:hover {
            text-decoration: underline;
        }
        .system-health {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .trend-improving { color: #28a745; }
        .trend-stable { color: #6c757d; }
        .trend-degrading { color: #dc3545; }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <nav class="navbar navbar-dark bg-dark mb-4">
            <div class="navbar-brand">
                üöÄ NIS Protocol v3 - Real-Time Performance Dashboard
            </div>
            <div class="navbar-text" id="connection-status">
                <span class="badge bg-secondary">Connecting...</span>
            </div>
        </nav>

        <!-- System Health Overview -->
        <div id="system-health" class="system-health">
            <div class="row">
                <div class="col-md-3">
                    <h4>System Health</h4>
                    <div id="health-score" class="metric-value">---%</div>
                </div>
                <div class="col-md-3">
                    <h5>Uptime</h5>
                    <div id="uptime" class="h5">-- hours</div>
                </div>
                <div class="col-md-3">
                    <h5>Integrity Score</h5>
                    <div id="integrity-score" class="h5">--/100</div>
                </div>
                <div class="col-md-3">
                    <h5>Active Alerts</h5>
                    <div id="alert-count" class="h5">--</div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics Grid -->
        <div class="row" id="metrics-container">
            <!-- Metrics cards will be dynamically generated here -->
        </div>

        <!-- Performance Charts -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Response Time Trend</h5>
                    <div id="response-time-chart" style="height: 300px;"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Accuracy Metrics</h5>
                    <div id="accuracy-chart" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Memory Usage</h5>
                    <div id="memory-chart" style="height: 300px;"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>System Integrity</h5>
                    <div id="integrity-chart" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- Evidence Validation Panel -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä Evidence Validation Status</h5>
                    </div>
                    <div class="card-body" id="evidence-panel">
                        <!-- Evidence validation status will be shown here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let chartData = {
            responseTime: [],
            accuracy: [],
            memory: [],
            integrity: [],
            timestamps: []
        };

        // Connection status
        socket.on('connect', function() {
            document.getElementById('connection-status').innerHTML = 
                '<span class="badge bg-success">Connected</span>';
        });

        socket.on('disconnect', function() {
            document.getElementById('connection-status').innerHTML = 
                '<span class="badge bg-danger">Disconnected</span>';
        });

        // Handle metrics updates
        socket.on('metrics_update', function(data) {
            updateSystemHealth(data.system_health);
            updateMetrics(data.metrics);
            updateCharts(data.metrics, data.timestamp);
        });

        function updateSystemHealth(health) {
            document.getElementById('health-score').textContent = 
                health.overall_score.toFixed(1) + '%';
            document.getElementById('uptime').textContent = 
                health.uptime_hours.toFixed(2) + ' hours';
            document.getElementById('integrity-score').textContent = 
                health.last_audit_score.toFixed(0) + '/100';
            document.getElementById('alert-count').textContent = 
                health.active_alerts.length;
        }

        function updateMetrics(metrics) {
            const container = document.getElementById('metrics-container');
            container.innerHTML = '';

            for (const [name, metric] of Object.entries(metrics)) {
                const col = document.createElement('div');
                col.className = 'col-lg-4 col-md-6 mb-3';
                
                const trendIcon = metric.trend === 'improving' ? 'üìà' : 
                                metric.trend === 'degrading' ? 'üìâ' : '‚û°Ô∏è';
                const trendClass = `trend-${metric.trend}`;

                col.innerHTML = `
                    <div class="card metric-card ${metric.alert_level} h-100">
                        <div class="card-body">
                            <h6 class="card-title">${formatMetricName(name)}</h6>
                            <div class="metric-value">${metric.current_value.toFixed(2)} ${metric.unit}</div>
                            <div class="metric-target">Target: ${metric.target_value} ${metric.unit}</div>
                            <div class="mt-2">
                                <span class="${trendClass}">${trendIcon} ${metric.trend}</span>
                                <span class="badge bg-${getAlertColor(metric.alert_level)} ms-2">${metric.alert_level}</span>
                            </div>
                            <div class="mt-2">
                                <small>CI: [${metric.confidence_interval[0].toFixed(2)}, ${metric.confidence_interval[1].toFixed(2)}]</small>
                            </div>
                            <div class="mt-2">
                                <a href="${metric.evidence_link}" class="evidence-link" target="_blank">
                                    üìã View Evidence
                                </a>
                            </div>
                            <div class="mt-1">
                                <small class="text-muted">${metric.validation_method}</small>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            }
        }

        function updateCharts(metrics, timestamp) {
            // Add new data points
            chartData.timestamps.push(new Date(timestamp * 1000));
            
            if (metrics.consciousness_response_time) {
                chartData.responseTime.push(metrics.consciousness_response_time.current_value);
            }
            if (metrics.decision_quality_accuracy) {
                chartData.accuracy.push(metrics.decision_quality_accuracy.current_value);
            }
            if (metrics.memory_efficiency) {
                chartData.memory.push(metrics.memory_efficiency.current_value);
            }
            if (metrics.integrity_score) {
                chartData.integrity.push(metrics.integrity_score.current_value);
            }

            // Keep only last 100 points
            const maxPoints = 100;
            if (chartData.timestamps.length > maxPoints) {
                chartData.timestamps = chartData.timestamps.slice(-maxPoints);
                chartData.responseTime = chartData.responseTime.slice(-maxPoints);
                chartData.accuracy = chartData.accuracy.slice(-maxPoints);
                chartData.memory = chartData.memory.slice(-maxPoints);
                chartData.integrity = chartData.integrity.slice(-maxPoints);
            }

            // Update charts
            updateChart('response-time-chart', chartData.timestamps, chartData.responseTime, 'Response Time (ms)', '#ff6b6b');
            updateChart('accuracy-chart', chartData.timestamps, chartData.accuracy, 'Accuracy (%)', '#4ecdc4');
            updateChart('memory-chart', chartData.timestamps, chartData.memory, 'Memory (MB)', '#45b7d1');
            updateChart('integrity-chart', chartData.timestamps, chartData.integrity, 'Integrity Score', '#96ceb4');
        }

        function updateChart(elementId, x, y, title, color) {
            const trace = {
                x: x,
                y: y,
                type: 'scatter',
                mode: 'lines+markers',
                name: title,
                line: { color: color, width: 2 },
                marker: { size: 4 }
            };

            const layout = {
                title: title,
                xaxis: { title: 'Time' },
                yaxis: { title: title },
                margin: { t: 40, r: 20, b: 40, l: 60 },
                showlegend: false
            };

            Plotly.newPlot(elementId, [trace], layout, { responsive: true, displayModeBar: false });
        }

        function formatMetricName(name) {
            return name.replace(/_/g, ' ')
                      .replace(/\b\w/g, l => l.toUpperCase());
        }

        function getAlertColor(level) {
            switch(level) {
                case 'normal': return 'success';
                case 'warning': return 'warning';
                case 'critical': return 'danger';
                default: return 'secondary';
            }
        }

        // Request initial data
        fetch('/api/metrics')
            .then(response => response.json())
            .then(data => {
                updateSystemHealth(data.system_health);
                updateMetrics(data.metrics);
            })
            .catch(error => {
                console.error('Error fetching initial metrics:', error);
            });

        // Update evidence panel
        function updateEvidencePanel() {
            fetch('/api/evidence')
                .then(response => response.json())
                .then(data => {
                    const panel = document.getElementById('evidence-panel');
                    let html = '<div class="row">';
                    
                    for (const [claim, evidence] of Object.entries(data.evidence_validation)) {
                        html += `
                            <div class="col-md-6 mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>${formatMetricName(claim)}</span>
                                    <a href="${evidence.evidence_link}" target="_blank" class="btn btn-sm btn-outline-primary">
                                        üìã Evidence
                                    </a>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    panel.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error fetching evidence data:', error);
                });
        }

        // Update evidence panel on load
        setTimeout(updateEvidencePanel, 1000);
    </script>
</body>
</html> 